{% extends "admin/admin_base.html" %}

{% block page_title %}联飞活动管理{% endblock %}

{% block admin_content %}
<div class="admin-flight-events">
    <!-- 添加活动按钮 -->
    <div class="mb-4">
        <button class="admin-btn admin-btn-success" data-toggle="modal" data-target="#addFlightEventModal">
            <i class="fas fa-plus"></i> 添加联飞活动
        </button>
    </div>
    
    <div class="admin-card">
        <div class="admin-card-header">
            <h3>联飞活动列表</h3>
        </div>
        <div class="admin-card-body">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>活动名称</th>
                        <th>创建时间</th>
                        <th>参与者数量</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr>
                        <td>{{ event.id }}</td>
                        <td>{{ event.name }}</td>
                        <td>{{ event.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>{{ event.participants|length }}</td>
                        <td>
                            <div class="admin-btn-group">
                                <a href="{{ url_for('flight_details', event_id=event.id) }}" class="admin-btn admin-btn-primary">查看详情</a>
                                <button class="admin-btn admin-btn-secondary" data-toggle="modal" data-target="#editFlightEventModal" 
                                    data-id="{{ event.id }}" 
                                    data-name="{{ event.name }}" 
                                    data-description="{{ event.description }}" 
                                    data-start_time="{{ event.start_time.strftime('%Y-%m-%dT%H:%M') if event.start_time else '' }}" 
                                    data-location="{{ event.location }}" 
                                    data-contact_person="{{ event.contact_person }}" 
                                    data-max_participants="{{ event.max_participants }}" 
                                    data-status="{{ event.status }}" 
                                    data-notes="{{ event.notes }}">
                                    编辑
                                </button>
                                <form action="{{ url_for('admin_delete_flight_event', event_id=event.id) }}" method="POST" style="display: inline;">
                                    <input type="hidden" name="_method" value="DELETE">
                                    <button type="submit" class="admin-btn admin-btn-danger" onclick="return confirm('确定要删除这个联飞活动吗？这将同时删除所有相关的报名记录。');">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 添加联飞活动的模态框 -->
<div id="addFlightEventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>添加联飞活动</h3>
            <button class="close" onclick="document.getElementById('addFlightEventModal').style.display='none'">×</button>
        </div>
        <div class="modal-body">
            <form action="{{ url_for('admin_add_flight_event') }}" method="POST">
                <div class="form-group">
                    <label for="event_name">活动名称 <span style="color:red;">*</span></label>
                    <input type="text" id="event_name" name="event_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="event_description">活动描述</label>
                    <textarea id="event_description" name="event_description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="event_start_time">开始时间 <span style="color:red;">*</span></label>
                    <input type="datetime-local" id="event_start_time" name="event_start_time" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="event_location">活动地点/航线</label>
                    <input type="text" id="event_location" name="event_location" class="form-control">
                </div>
                <div class="form-group">
                    <label for="event_contact_person">负责人/联系人</label>
                    <input type="text" id="event_contact_person" name="event_contact_person" class="form-control">
                </div>
                <div class="form-group">
                    <label for="event_max_participants">最大参与人数（0表示无限制）</label>
                    <input type="number" id="event_max_participants" name="event_max_participants" class="form-control" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="event_status">活动状态</label>
                    <select id="event_status" name="event_status" class="form-control">
                        <option value="upcoming">即将开始</option>
                        <option value="ongoing">进行中</option>
                        <option value="completed">已完成</option>
                        <option value="canceled">已取消</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event_notes">活动说明/公告</label>
                    <textarea id="event_notes" name="event_notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="admin-btn admin-btn-success">保存</button>
                    <button type="button" class="admin-btn admin-btn-secondary" onclick="document.getElementById('addFlightEventModal').style.display='none'">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑联飞活动的模态框 -->
<div id="editFlightEventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>编辑联飞活动</h3>
            <button class="close" onclick="document.getElementById('editFlightEventModal').style.display='none'">×</button>
        </div>
        <div class="modal-body">
            <form action="{{ url_for('admin_edit_flight_event') }}" method="POST">
                <input type="hidden" id="edit_event_id" name="event_id">
                <div class="form-group">
                    <label for="edit_event_name">活动名称 <span style="color:red;">*</span></label>
                    <input type="text" id="edit_event_name" name="event_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit_event_description">活动描述</label>
                    <textarea id="edit_event_description" name="event_description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit_event_start_time">开始时间 <span style="color:red;">*</span></label>
                    <input type="datetime-local" id="edit_event_start_time" name="event_start_time" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="edit_event_location">活动地点/航线</label>
                    <input type="text" id="edit_event_location" name="event_location" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit_event_contact_person">负责人/联系人</label>
                    <input type="text" id="edit_event_contact_person" name="event_contact_person" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit_event_max_participants">最大参与人数（0表示无限制）</label>
                    <input type="number" id="edit_event_max_participants" name="event_max_participants" class="form-control" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="edit_event_status">活动状态</label>
                    <select id="edit_event_status" name="event_status" class="form-control">
                        <option value="upcoming">即将开始</option>
                        <option value="ongoing">进行中</option>
                        <option value="completed">已完成</option>
                        <option value="canceled">已取消</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_event_notes">活动说明/公告</label>
                    <textarea id="edit_event_notes" name="event_notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="admin-btn admin-btn-primary">更新</button>
                    <button type="button" class="admin-btn admin-btn-secondary" onclick="document.getElementById('editFlightEventModal').style.display='none'">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* 模态框响应式调整 */
    @media (max-width: 768px) {
        .modal-content {
            width: 90% !important;
        }
    }
</style>

<style>
    /* 联飞活动管理页面特有的样式 */
    .admin-btn-group {
        display: flex;
        gap: 10px;
    }
    
    .admin-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    
    .admin-btn-primary {
        background-color: #1890ff;
        color: white;
    }
    
    .admin-btn-primary:hover {
        background-color: #40a9ff;
    }
    
    .admin-btn-danger {
        background-color: #ff4d4f;
        color: white;
    }
    
    .admin-btn-danger:hover {
        background-color: #ff7875;
    }
    
    .admin-btn-success {
        background-color: #52c41a;
        color: white;
    }
    
    .admin-btn-success:hover {
        background-color: #73d13d;
    }
    
    .admin-btn-secondary {
        background-color: #d9d9d9;
        color: #333;
    }
    
    .admin-btn-secondary:hover {
        background-color: #bfbfbf;
    }
    
    /* 模态框样式 */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        border-radius: 8px;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }
</style>

<script>
    // 简单的模态框控制脚本
    document.addEventListener('DOMContentLoaded', function() {
        // 获取所有带有data-toggle="modal"属性的按钮
        const modalButtons = document.querySelectorAll('[data-toggle="modal"]');
        
        modalButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const modal = document.querySelector(targetId);
                
                // 如果是编辑模态框，填充表单数据
                if (targetId === '#editFlightEventModal') {
                    document.getElementById('edit_event_id').value = this.getAttribute('data-id');
                    document.getElementById('edit_event_name').value = this.getAttribute('data-name');
                    document.getElementById('edit_event_description').value = this.getAttribute('data-description');
                    document.getElementById('edit_event_start_time').value = this.getAttribute('data-start_time');
                    document.getElementById('edit_event_location').value = this.getAttribute('data-location');
                    document.getElementById('edit_event_contact_person').value = this.getAttribute('data-contact_person');
                    document.getElementById('edit_event_max_participants').value = this.getAttribute('data-max_participants');
                    document.getElementById('edit_event_status').value = this.getAttribute('data-status');
                    document.getElementById('edit_event_notes').value = this.getAttribute('data-notes');
                }
                
                if (modal) {
                    modal.style.display = 'block';
                }
            });
        });
        
        // 点击模态框外部关闭模态框
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}